{
  "version": 3,
  "sources": ["../../wa-sqlite/src/examples/WebLocks.js", "../../wa-sqlite/src/examples/IDBContext.js"],
  "sourcesContent": ["// Copyright 2022 Roy T. Hashimoto. All Rights Reserved.\nimport * as VFS from '../VFS.js';\n\nconst LOCK_TYPE_MASK =\n  VFS.SQLITE_LOCK_NONE |\n  VFS.SQLITE_LOCK_SHARED |\n  VFS.SQLITE_LOCK_RESERVED |\n  VFS.SQLITE_LOCK_PENDING |\n  VFS.SQLITE_LOCK_EXCLUSIVE;\n\nexport class WebLocksBase {\n  get state() { return this.#state; }\n  #state = VFS.SQLITE_LOCK_NONE;\n\n  timeoutMillis = 0;\n\n  /** @type {Map<string, (value: any) => void>} */ #releasers = new Map();\n  /** @type {Promise<0|5|3850>} */ #pending = Promise.resolve(0);\n\n  /**\n   * @param {number} flags \n   * @returns {Promise<0|5|3850>} SQLITE_OK, SQLITE_BUSY, SQLITE_IOERR_LOCK\n   */\n  async lock(flags) {\n    return this.#apply(this.#lock, flags);\n  }\n\n  /**\n   * @param {number} flags \n   * @returns {Promise<0|5|3850>} SQLITE_OK, SQLITE_IOERR_LOCK\n   */\n  async unlock(flags) {\n    return this.#apply(this.#unlock, flags);\n  }\n\n  /**\n   * @returns {Promise<boolean>}\n   */\n  async isSomewhereReserved() {\n    throw new Error('unimplemented');\n  }\n\n  /**\n   * \n   * @param {(targetState: number) => void} method \n   * @param {number} flags \n   */\n  async #apply(method, flags) {\n    const targetState = flags & LOCK_TYPE_MASK;\n    try {\n      // Force locks and unlocks to run sequentially. This allows not\n      // waiting for unlocks to complete.\n      const call = () => method.call(this, targetState);\n      await (this.#pending = this.#pending.then(call, call));\n      this.#state = targetState;\n      return VFS.SQLITE_OK;\n    } catch (e) {\n      if (e.name === 'AbortError') {\n        return VFS.SQLITE_BUSY;\n      }\n      console.error(e);\n      return VFS.SQLITE_IOERR_LOCK;\n    }\n  }\n\n  async #lock(targetState) {\n    if (targetState === this.#state) return VFS.SQLITE_OK;\n    switch (this.#state) {\n      case VFS.SQLITE_LOCK_NONE:\n        switch (targetState) {\n          case VFS.SQLITE_LOCK_SHARED:\n            return this._NONEtoSHARED();\n          default:\n            throw new Error(`unexpected transition ${this.#state} -> ${targetState}`);\n        }\n\n      case VFS.SQLITE_LOCK_SHARED:\n        switch (targetState) {\n          case VFS.SQLITE_LOCK_RESERVED:\n            return this._SHAREDtoRESERVED();\n          case VFS.SQLITE_LOCK_EXCLUSIVE:\n            return this._SHAREDtoEXCLUSIVE();\n          default:\n            throw new Error(`unexpected transition ${this.#state} -> ${targetState}`);\n        }\n      \n      case VFS.SQLITE_LOCK_RESERVED:\n        switch (targetState) {\n          case VFS.SQLITE_LOCK_EXCLUSIVE:\n            return this._RESERVEDtoEXCLUSIVE();\n          default:\n            throw new Error(`unexpected transition ${this.#state} -> ${targetState}`);\n        }\n\n      default:\n        throw new Error(`unexpected transition ${this.#state} -> ${targetState}`);\n    }\n  }\n\n  async #unlock(targetState) {\n    if (targetState === this.#state)  return VFS.SQLITE_OK;\n    switch (this.#state) {\n      case VFS.SQLITE_LOCK_EXCLUSIVE:\n        switch (targetState) {\n          case VFS.SQLITE_LOCK_SHARED:\n            return this._EXCLUSIVEtoSHARED();\n          case VFS.SQLITE_LOCK_NONE:\n            return this._EXCLUSIVEtoNONE();\n          default:\n            throw new Error(`unexpected transition ${this.#state} -> ${targetState}`);\n        }\n      \n      case VFS.SQLITE_LOCK_RESERVED:\n        switch (targetState) {\n          case VFS.SQLITE_LOCK_SHARED:\n            return this._RESERVEDtoSHARED();\n          case VFS.SQLITE_LOCK_NONE:\n            return this._RESERVEDtoNONE();\n          default:\n            throw new Error(`unexpected transition ${this.#state} -> ${targetState}`);\n        }\n\n      case VFS.SQLITE_LOCK_SHARED:\n        switch (targetState) {\n          case VFS.SQLITE_LOCK_NONE:\n            return this._SHAREDtoNONE();\n          default:\n            throw new Error(`unexpected transition ${this.#state} -> ${targetState}`);\n        }\n\n      default:\n        throw new Error(`unexpected transition ${this.#state} -> ${targetState}`);\n    }\n  }\n\n  async _NONEtoSHARED() {\n  }\n\n  async _SHAREDtoEXCLUSIVE() {\n    await this._SHAREDtoRESERVED();\n    await this._RESERVEDtoEXCLUSIVE();\n  }\n\n  async _SHAREDtoRESERVED() {\n  }\n\n  async _RESERVEDtoEXCLUSIVE() {\n  }\n\n  async _EXCLUSIVEtoRESERVED() {\n  }\n\n  async _EXCLUSIVEtoSHARED() {\n    await this._EXCLUSIVEtoRESERVED();\n    await this._RESERVEDtoSHARED();\n  }\n\n  async _EXCLUSIVEtoNONE() {\n    await this._EXCLUSIVEtoRESERVED();\n    await this._RESERVEDtoSHARED();\n    await this._SHAREDtoNONE();\n  }\n\n  async _RESERVEDtoSHARED() {\n  }\n\n  async _RESERVEDtoNONE() {\n    await this._RESERVEDtoSHARED();\n    await this._SHAREDtoNONE();\n  }\n\n  async _SHAREDtoNONE() {\n  }\n\n  /**\n   * @param {string} lockName \n   * @param {LockOptions} options \n   * @returns {Promise<?Lock>}\n   */\n  _acquireWebLock(lockName, options) {\n    return new Promise(async (resolve, reject) => {\n      try {\n        await navigator.locks.request(lockName, options, lock => {\n          resolve(lock);\n          if (lock) {\n            return new Promise(release => this.#releasers.set(lockName, release));\n          }\n        });\n      } catch(e) {\n        reject(e);\n      }\n    });\n  }\n\n  /**\n   * @param {string} lockName \n   */\n  _releaseWebLock(lockName) {\n    this.#releasers.get(lockName)?.();\n    this.#releasers.delete(lockName);\n  }\n\n  /**\n   * @param {string} lockName \n   */\n  async _pollWebLock(lockName) {\n    const query = await navigator.locks.query();\n    return query.held.find(({name}) => name === lockName)?.mode;\n  }\n\n  /**\n   * @returns {?AbortSignal}\n   */\n  _getTimeoutSignal() {\n    if (this.timeoutMillis) {\n      const abortController = new AbortController();\n      setTimeout(() => abortController.abort(), this.timeoutMillis);\n      return abortController.signal;\n    }\n    return undefined;\n  }\n}\n\nexport class WebLocksExclusive extends WebLocksBase {\n  /**\n   * @param {string} name \n   */\n  constructor(name) {\n    super();\n    this._lockName = name + '-outer';\n    this._reservedName = name + '-reserved';\n  }\n\n  async isSomewhereReserved() {\n    const mode = await this._pollWebLock(this._reservedName);\n    return mode === 'exclusive';\n  }\n\n  async _NONEtoSHARED() {\n    await this._acquireWebLock(this._lockName, {\n      mode: 'exclusive',\n      signal: this._getTimeoutSignal()\n    });\n  }\n\n  async _SHAREDtoRESERVED() {\n    await this._acquireWebLock(this._reservedName, {\n      mode: 'exclusive',\n      signal: this._getTimeoutSignal()\n    });\n  }\n\n  async _RESERVEDtoSHARED() {\n    this._releaseWebLock(this._reservedName);\n  }\n\n  async _SHAREDtoNONE() {\n    this._releaseWebLock(this._lockName);\n  }\n}\n\nexport class WebLocksShared extends WebLocksBase {\n  maxRetryMillis = 1000;\n\n  /**\n   * @param {string} name \n   */\n  constructor(name) {\n    super();\n    this._outerName = name + '-outer';\n    this._innerName = name + '-inner';\n  }\n\n  async isSomewhereReserved() {\n    const mode = await this._pollWebLock(this._outerName);\n    return mode === 'exclusive';\n  }\n\n  async _NONEtoSHARED() {\n    await this._acquireWebLock(this._outerName, {\n      mode: 'shared',\n      signal: this._getTimeoutSignal()\n    });\n    await this._acquireWebLock(this._innerName, {\n      mode: 'shared',\n      signal: this._getTimeoutSignal()\n    });\n    this._releaseWebLock(this._outerName);\n  }\n\n  async _SHAREDtoRESERVED() {\n    let timeoutMillis = 1;\n    while (true) {\n      // Attempt to get the outer lock without blocking.\n      const isLocked = await this._acquireWebLock(this._outerName, {\n        mode: 'exclusive',\n        ifAvailable: true\n      });\n      if (isLocked) break;\n\n      if (await this.isSomewhereReserved()) {\n        // Someone else has a reserved lock so retry cannot succeed.\n        throw new DOMException('', 'AbortError');\n      }\n\n      await new Promise(resolve => setTimeout(resolve, timeoutMillis));\n      timeoutMillis = Math.min(2 * timeoutMillis, this.maxRetryMillis);\n    }\n    this._releaseWebLock(this._innerName);\n  }\n\n  async _RESERVEDtoEXCLUSIVE() {\n    await this._acquireWebLock(this._innerName, {\n      mode: 'exclusive',\n      signal: this._getTimeoutSignal()\n    });\n  }\n\n  async _EXCLUSIVEtoRESERVED() {\n    this._releaseWebLock(this._innerName);\n  }\n\n  async _RESERVEDtoSHARED() {\n    await this._acquireWebLock(this._innerName, { mode: 'shared' });\n    this._releaseWebLock(this._outerName);\n  }\n\n  async _SHAREDtoNONE() {\n    this._releaseWebLock(this._innerName);\n  }\n}", "// Copyright 2022 Roy T. Hashimoto. All Rights Reserved.\n\n// IndexedDB transactions older than this will be replaced.\nconst MAX_TRANSACTION_LIFETIME_MILLIS = 5_000;\n\n// For debugging.\nlet nextTxId = 0;\nconst mapTxToId = new WeakMap();\nfunction log(...args) {\n  // console.debug(...args);\n}\n\n// This class manages IDBTransaction and IDBRequest instances. It tries\n// to reuse transactions to minimize transaction overhead.\nexport class IDBContext {\n  /** @type {IDBDatabase} */ #db;\n  /** @type {Promise<IDBDatabase>} */ #dbReady;\n  #txOptions;\n\n  /** @type {IDBTransaction} */ #tx = null;\n  #txTimestamp = 0;\n  #runChain = Promise.resolve();\n  #putChain = Promise.resolve();\n\n  /**\n   * @param {IDBDatabase|Promise<IDBDatabase>} idbDatabase\n   */\n  constructor(idbDatabase, txOptions = { durability: 'default' }) {\n    this.#dbReady = Promise.resolve(idbDatabase).then(db => this.#db = db);\n    this.#txOptions = txOptions;\n  }\n\n  async close() {\n    const db = this.#db ?? await this.#dbReady;\n    await this.#runChain;\n    await this.sync();\n    db.close();\n  }\n  \n  /**\n   * Run a function with the provided object stores. The function\n   * should be idempotent in case it is passed an expired transaction.\n   * @param {IDBTransactionMode} mode\n   * @param {(stores: Object.<string, ObjectStore>) => any} f \n   */\n  async run(mode, f) {\n    // Ensure that functions run sequentially.\n    const result = this.#runChain.then(() => this.#run(mode, f));\n    this.#runChain = result.catch(() => {});\n    return result;\n  }\n\n  /**\n   * @param {IDBTransactionMode} mode\n   * @param {(stores: Object.<string, ObjectStore>) => any} f \n   * @returns \n   */\n  async #run(mode, f) {\n    const db = this.#db ?? await this.#dbReady;\n    if (mode === 'readwrite' && this.#tx?.mode === 'readonly') {\n      // Mode requires a new transaction.\n      this.#tx = null;\n    } else if (performance.now() - this.#txTimestamp > MAX_TRANSACTION_LIFETIME_MILLIS) {\n      // Chrome times out transactions after 60 seconds so refresh preemptively.\n      try {\n        this.#tx?.commit();\n      } catch (e) {\n        // Explicit commit can fail but this can be ignored if it will\n        // auto-commit anyway.\n        if (e.name !== 'InvalidStateError') throw e;\n      }\n\n      // Skip to the next task to allow processing.\n      await new Promise(resolve => setTimeout(resolve));\n      this.#tx = null;\n    }\n\n    // Run the user function with a retry in case the transaction is invalid.\n    for (let i = 0; i < 2; ++i) {\n      if (!this.#tx) {\n        // @ts-ignore\n        this.#tx = db.transaction(db.objectStoreNames, mode, this.#txOptions);\n        const timestamp = this.#txTimestamp = performance.now();\n\n        // Chain the result of every transaction. If any transaction is\n        // aborted then the next sync() call will throw.\n        this.#putChain = this.#putChain.then(() => {\n          return new Promise((resolve, reject) => {\n            this.#tx.addEventListener('complete', event => {\n              resolve();\n              if (this.#tx === event.target) {\n                this.#tx = null;\n              }\n              log(`transaction ${mapTxToId.get(event.target)} complete`);\n            });\n            this.#tx.addEventListener('abort', event => {\n              console.warn('tx abort', (performance.now() - timestamp)/1000);\n              // @ts-ignore\n              const e = event.target.error;\n              reject(e);\n              if (this.#tx === event.target) {\n                this.#tx = null;\n              }\n              log(`transaction ${mapTxToId.get(event.target)} aborted`, e);\n            });\n          });\n        });\n\n        log(`new transaction ${nextTxId} ${mode}`);\n        mapTxToId.set(this.#tx, nextTxId++);\n      }\n\n      try {\n        const stores = Object.fromEntries(Array.from(db.objectStoreNames, name => {\n          return [name, new ObjectStore(this.#tx.objectStore(name))];\n        }));\n        return await f(stores);\n      } catch (e) {\n        this.#tx = null;\n        if (i) throw e;\n        // console.warn('retrying with new transaction');\n      }\n    }\n  }\n\n  async sync() {\n    // Wait until all transactions since the previous sync have committed.\n    // Throw if any transaction failed.\n    await this.#runChain;\n    await this.#putChain;\n    this.#putChain = Promise.resolve();\n  }\n}\n\n/**\n * Helper to convert IDBRequest to Promise.\n * @param {IDBRequest} request \n * @returns {Promise}\n */\nfunction wrapRequest(request) {\n  return new Promise((resolve, reject) => {\n    request.addEventListener('success', () => resolve(request.result));\n    request.addEventListener('error', () => reject(request.error));\n  });\n}\n\n// IDBObjectStore wrapper passed to IDBContext run functions.\nclass ObjectStore {\n  #objectStore;\n\n  /**\n   * @param {IDBObjectStore} objectStore \n   */\n  constructor(objectStore) {\n    this.#objectStore = objectStore;\n  }\n\n  /**\n   * @param {IDBValidKey|IDBKeyRange} query \n   * @returns {Promise}\n   */\n  get(query) {\n    log(`get ${this.#objectStore.name}`, query);\n    const request = this.#objectStore.get(query);\n    return wrapRequest(request);\n  }\n\n  /**\n   * @param {IDBValidKey|IDBKeyRange} query \n   * @param {number} [count]\n   * @returns {Promise}\n   */\n   getAll(query, count) {\n    log(`getAll ${this.#objectStore.name}`, query, count);\n    const request = this.#objectStore.getAll(query, count);\n    return wrapRequest(request);\n  }\n\n  /**\n   * @param {IDBValidKey|IDBKeyRange} query \n   * @returns {Promise<IDBValidKey>}\n   */\n  getKey(query) {\n    log(`getKey ${this.#objectStore.name}`, query);\n    const request = this.#objectStore.getKey(query);\n    return wrapRequest(request);\n  }\n\n  /**\n   * @param {IDBValidKey|IDBKeyRange} query \n   * @param {number} [count]\n   * @returns {Promise}\n   */\n   getAllKeys(query, count) {\n    log(`getAllKeys ${this.#objectStore.name}`, query, count);\n    const request = this.#objectStore.getAllKeys(query, count);\n    return wrapRequest(request);\n  }\n\n  /**\n   * @param {any} value\n   * @param {IDBValidKey} [key] \n   * @returns {Promise}\n   */\n   put(value, key) {\n    log(`put ${this.#objectStore.name}`, value, key);\n    const request = this.#objectStore.put(value, key);\n    return wrapRequest(request);\n  }\n\n  /**\n   * @param {IDBValidKey|IDBKeyRange} query \n   * @returns {Promise}\n   */\n   delete(query) {\n    log(`delete ${this.#objectStore.name}`, query);\n    const request = this.#objectStore.delete(query);\n    return wrapRequest(request);\n  }\n\n  clear() {\n    log(`clear ${this.#objectStore.name}`);\n    const request = this.#objectStore.clear();\n    return wrapRequest(request);\n  }\n\n  index(name) {\n    return new Index(this.#objectStore.index(name));\n  }\n}\n\nclass Index {\n  /** @type {IDBIndex} */ #index;\n\n  /**\n   * @param {IDBIndex} index \n   */\n   constructor(index) {\n    this.#index = index;\n  }\n\n  /**\n   * @param {IDBValidKey|IDBKeyRange} query \n   * @param {number} [count]\n   * @returns {Promise<IDBValidKey[]>}\n   */\n  getAllKeys(query, count) {\n    log(`IDBIndex.getAllKeys ${this.#index.objectStore.name}<${this.#index.name}>`, query, count);\n    const request = this.#index.getAllKeys(query, count);\n    return wrapRequest(request);\n  }\n}"],
  "mappings": "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",
  "names": []
}
