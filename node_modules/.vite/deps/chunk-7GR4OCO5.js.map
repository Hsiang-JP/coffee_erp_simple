{
  "version": 3,
  "sources": ["../../wa-sqlite/src/examples/MemoryVFS.js"],
  "sourcesContent": ["// Copyright 2021 Roy T. Hashimoto. All Rights Reserved.\nimport * as VFS from '../VFS.js';\n\n// Memory filesystem. Although this is mainly provided as an example\n// for new VFS classes, it seems to be faster than the default filesystem.\nexport class MemoryVFS extends VFS.Base {\n  name = 'memory';\n  \n  // Map of existing files, keyed by filename.\n  mapNameToFile = new Map();\n\n  // Map of open files, keyed by id (sqlite3_file pointer).\n  mapIdToFile = new Map();\n\n  constructor() {\n    super();\n  }\n\n  close() {\n    for (const fileId of this.mapIdToFile.keys()) {\n      this.xClose(fileId);\n    }\n  }\n\n  /**\n   * @param {string?} name \n   * @param {number} fileId \n   * @param {number} flags \n   * @param {DataView} pOutFlags \n   * @returns {number}\n   */\n  xOpen(name, fileId, flags, pOutFlags) {\n    // Generate a random name if requested.\n    name = name || Math.floor(Math.random() * Number.MAX_SAFE_INTEGER).toString(36);\n\n    let file = this.mapNameToFile.get(name);\n    if (!file) {\n      if (flags & VFS.SQLITE_OPEN_CREATE) {\n        // Create a new file object.\n        file = {\n          name,\n          flags,\n          size: 0,\n          data: new ArrayBuffer(0)\n        };\n        this.mapNameToFile.set(name, file);\n      } else {\n        return VFS.SQLITE_CANTOPEN;\n      }\n    }\n\n    // Put the file in the opened files map.\n    this.mapIdToFile.set(fileId, file);\n    pOutFlags.setInt32(0, flags, true);\n    return VFS.SQLITE_OK;\n  }\n\n  /**\n   * @param {number} fileId \n   * @returns {number}\n   */\n  xClose(fileId) {\n    const file = this.mapIdToFile.get(fileId);\n    this.mapIdToFile.delete(fileId);\n\n    if (file.flags & VFS.SQLITE_OPEN_DELETEONCLOSE) {\n      this.mapNameToFile.delete(file.name);\n    }\n    return VFS.SQLITE_OK;\n  }\n\n  /**\n   * @param {number} fileId \n   * @param {Uint8Array} pData \n   * @param {number} iOffset\n   * @returns {number}\n   */\n  xRead(fileId, pData, iOffset) {\n    const file = this.mapIdToFile.get(fileId);\n\n    // Clip the requested read to the file boundary.\n    const bgn = Math.min(iOffset, file.size);\n    const end = Math.min(iOffset + pData.byteLength, file.size);\n    const nBytes = end - bgn;\n\n    if (nBytes) {\n      pData.set(new Uint8Array(file.data, bgn, nBytes));\n    }\n\n    if (nBytes < pData.byteLength) {\n      // Zero unused area of read buffer.\n      pData.fill(0, nBytes);\n      return VFS.SQLITE_IOERR_SHORT_READ;\n    }\n    return VFS.SQLITE_OK;\n  }\n\n  /**\n   * @param {number} fileId \n   * @param {Uint8Array} pData \n   * @param {number} iOffset\n   * @returns {number}\n   */\n  xWrite(fileId, pData, iOffset) {\n    const file = this.mapIdToFile.get(fileId);\n    if (iOffset + pData.byteLength > file.data.byteLength) {\n      // Resize the ArrayBuffer to hold more data.\n      const newSize = Math.max(iOffset + pData.byteLength, 2 * file.data.byteLength);\n      const data = new ArrayBuffer(newSize);\n      new Uint8Array(data).set(new Uint8Array(file.data, 0, file.size));\n      file.data = data;\n    }\n\n    // Copy data.\n    new Uint8Array(file.data, iOffset, pData.byteLength).set(pData);\n    file.size = Math.max(file.size, iOffset + pData.byteLength);\n    return VFS.SQLITE_OK;\n  }\n\n  /**\n   * @param {number} fileId \n   * @param {number} iSize \n   * @returns {number}\n   */\n  xTruncate(fileId, iSize) {\n    const file = this.mapIdToFile.get(fileId);\n\n    // For simplicity we don't make the ArrayBuffer smaller.\n    file.size = Math.min(file.size, iSize);\n    return VFS.SQLITE_OK;\n  }\n\n  /**\n   * @param {number} fileId \n   * @param {DataView} pSize64 \n   * @returns {number}\n   */\n  xFileSize(fileId, pSize64) {\n    const file = this.mapIdToFile.get(fileId);\n\n    pSize64.setBigInt64(0, BigInt(file.size), true);\n    return VFS.SQLITE_OK;\n  }\n\n  /**\n   * \n   * @param {string} name \n   * @param {number} syncDir \n   * @returns {number}\n   */\n  xDelete(name, syncDir) {\n    this.mapNameToFile.delete(name);\n    return VFS.SQLITE_OK;\n  }\n\n  /**\n   * @param {string} name \n   * @param {number} flags \n   * @param {DataView} pResOut \n   * @returns {number}\n   */\n  xAccess(name, flags, pResOut) {\n    const file = this.mapNameToFile.get(name);\n    pResOut.setInt32(0, file ? 1 : 0, true);\n    return VFS.SQLITE_OK;\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
